---
import Layout from '../layouts/Layout.astro';
  const BASE_URL = import.meta.env.PUBLIC_BACKEND_URL;
  const API_URL = `${BASE_URL}/courses`; 

let courses = [];

try {
  const res = await fetch(API_URL);
  if (res.ok) {
    courses = await res.json();
  }
} catch (e) {
  console.error("Backend error:", e);
}
---

<Layout title="My Learning Path">
  <main class="min-h-screen bg-neutral-900 text-white p-8 font-sans relative">
    
    <div class="flex justify-between items-center mb-12">
      <h1 class="text-3xl font-bold tracking-tight">Available Courses</h1>
      <button id="openModalBtn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-bold transition shadow-lg flex items-center gap-2">
        <span>+</span> Add Course
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
      {courses.map((course: any) => (
        <div class="group relative block">
          
          {/* Edit / Delete Buttons */}
          <div class="absolute top-4 right-4 z-30 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            <button class="bg-neutral-800/80 hover:bg-blue-600 text-white p-2 rounded-full backdrop-blur-sm border border-neutral-600 transition-colors btn-edit"
              data-course={JSON.stringify(course)}>
              ‚úèÔ∏è
            </button>
            <button class="bg-neutral-800/80 hover:bg-red-600 text-white p-2 rounded-full backdrop-blur-sm border border-neutral-600 transition-colors btn-delete"
              data-id={course.id}>
              üóëÔ∏è
            </button>
          </div>

          <a href={`/course/${course.id}`}>
            <div class="relative bg-neutral-800 border-[12px] border-neutral-700 rounded-[2.5rem] h-64 shadow-2xl transition-transform duration-300 group-hover:-translate-y-2 overflow-hidden">
              <div class="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none z-20"></div>
              <div class="h-full w-full bg-gradient-to-br from-neutral-800 to-black p-6 flex flex-col items-center justify-center text-center relative z-10">
                <h2 class="text-2xl font-bold text-white mb-2">{course.title}</h2>
                <p class="text-neutral-400 text-sm line-clamp-2">{course.description}</p>
                <div class="mt-6 px-5 py-2 bg-neutral-700 rounded-full text-xs font-bold uppercase group-hover:bg-blue-600 transition-colors">
                  Open App
                </div>
              </div>
            </div>
          </a>
        </div>
      ))}
    </div>

    {courses.length === 0 && (
      <div class="text-center text-neutral-500 mt-20">
        <p>No courses found. Click "Add Course" to start.</p>
      </div>
    )}

    {/* Modal */}
    <div id="courseModal" class="fixed inset-0 z-50 hidden">
      <div id="modalBackdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"></div>
      
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-neutral-800 w-full max-w-lg rounded-2xl border border-neutral-700 shadow-2xl transform transition-all scale-100 p-8 relative">
          
          <button id="closeModalBtn" class="absolute top-4 right-4 text-neutral-400 hover:text-white">‚úï</button>

          <h2 id="modalTitle" class="text-2xl font-bold mb-6">Create New Course</h2>

          <form id="courseForm" class="space-y-5">
            <input type="hidden" name="id" id="courseId" />

            <div>
              <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Title</label>
              <input type="text" name="title" id="inpTitle" required class="w-full bg-neutral-900 border border-neutral-700 rounded-lg p-3 focus:border-blue-500 outline-none transition text-white" placeholder="e.g. React Mastery" />
            </div>

            <div>
              <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Description</label>
              <textarea name="description" id="inpDesc" rows="3" class="w-full bg-neutral-900 border border-neutral-700 rounded-lg p-3 focus:border-blue-500 outline-none transition text-white" placeholder="Course details..."></textarea>
            </div>

            <div class="pt-4 border-t border-neutral-700">
              <div class="flex justify-between items-center mb-4">
                <label class="text-xs font-bold text-neutral-500 uppercase">Content Links</label>
                <div class="flex gap-2">
                  <button type="button" id="btnVideo" class="text-xs bg-red-900/30 text-red-400 hover:bg-red-900/50 px-3 py-1 rounded border border-red-900/50 transition">+ Video</button>
                  <button type="button" id="btnPdf" class="text-xs bg-blue-900/30 text-blue-400 hover:bg-blue-900/50 px-3 py-1 rounded border border-blue-900/50 transition">+ PDF</button>
                </div>
              </div>
              
              <div id="sectionContainer" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                <div class="text-xs text-neutral-600 italic text-center py-2" id="emptyMsg">No links added yet</div>
              </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-4 transition shadow-lg shadow-blue-900/20">
              Publish Course
            </button>
          </form>

        </div>
      </div>
    </div>

  </main>
</Layout>

<script>
  // ==========================================
  // CLIENT-SIDE LOGIC
  // ==========================================
  
  // Global state for rendering (initial load)
  let sections = []; 

  // DOM Elements
  const modal = document.getElementById('courseModal');
  const modalTitle = document.getElementById('modalTitle');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('courseForm') as HTMLFormElement;
  const sectionContainer = document.getElementById('sectionContainer');
  const emptyMsg = document.getElementById('emptyMsg');
  
  // Inputs
  const inpId = document.getElementById('courseId') as HTMLInputElement;
  const inpTitle = document.getElementById('inpTitle') as HTMLInputElement;
  const inpDesc = document.getElementById('inpDesc') as HTMLTextAreaElement;

  // --- 1. Modal Logic ---
  const toggleModal = (show) => {
    if(show) modal.classList.remove('hidden');
    else modal.classList.add('hidden');
  };

  const resetForm = () => {
    form.reset();
    inpId.value = "";
    sections = [];
    modalTitle.textContent = "Create New Course";
    submitBtn.textContent = "Publish Course";
    renderSections();
  };

  document.getElementById('openModalBtn').addEventListener('click', () => {
    resetForm();
    toggleModal(true);
  });

  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const courseStr = (btn as HTMLElement).dataset.course;
      const course = JSON.parse(courseStr);
      
      inpId.value = course.id;
      inpTitle.value = course.title;
      inpDesc.value = course.description;
      
      // Handle parsing if it came back as a string, otherwise use array
      if (typeof course.sections === 'string') {
          try { sections = JSON.parse(course.sections); } catch(e) { sections = []; }
      } else {
          sections = course.sections || [];
      }
      
      modalTitle.textContent = "Edit Course";
      submitBtn.textContent = "Save Changes";
      renderSections();
      toggleModal(true);
    });
  });

  document.getElementById('closeModalBtn').addEventListener('click', () => toggleModal(false));
  document.getElementById('modalBackdrop').addEventListener('click', () => toggleModal(false));

  // --- 2. Delete Logic ---
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if(!confirm("Are you sure you want to delete this course?")) return;
      
      const id = (btn as HTMLElement).dataset.id;
      const originalText = btn.textContent;
      btn.textContent = "‚è≥";

      try {
        const res = await fetch(`http://localhost:8787/courses/${id}`, { method: 'DELETE' });
        if(res.ok) window.location.reload();
        else alert("Failed to delete");
      } catch(err) { 
        console.error(err); 
        alert("Delete failed");
      } finally {
        btn.textContent = originalText;
      }
    });
  });

  // --- 3. Dynamic Sections Logic ---
  function renderSections() {
    // Clear current list in DOM (keep emptyMsg)
    Array.from(sectionContainer.children).forEach(child => {
        if(child.id !== 'emptyMsg') child.remove();
    });

    if(sections.length > 0) emptyMsg.classList.add('hidden');
    else emptyMsg.classList.remove('hidden');

    const html = sections.map((s, i) => `
      <div class="section-row flex gap-2 items-center bg-neutral-900 p-2 rounded border border-neutral-700 animate-fade-in">
        <input type="hidden" class="inp-type" value="${s.type}" />
        
        <span class="text-[10px] font-bold uppercase w-10 text-center ${s.type === 'video' ? 'text-red-400' : 'text-blue-400'}">
            ${s.type === 'video' ? 'VIDEO' : 'PDF'}
        </span>
        
        <input type="text" placeholder="Label" value="${s.label || ''}"
               class="inp-label bg-transparent border-b border-neutral-800 focus:border-blue-500 outline-none text-xs w-24 text-white px-1 py-1 transition-colors" />
               
        <input type="text" placeholder="URL" value="${s.url || ''}"
               class="inp-url bg-transparent border-b border-neutral-800 focus:border-blue-500 outline-none text-xs flex-1 text-neutral-300 px-1 py-1 transition-colors" />
               
        <button type="button" class="btn-remove text-neutral-600 hover:text-red-400 px-1">√ó</button>
      </div>
    `).join('');
    
    sectionContainer.insertAdjacentHTML('beforeend', html);

    // Attach Remove Listeners to new elements
    sectionContainer.querySelectorAll('.btn-remove').forEach((btn, index) => {
        btn.addEventListener('click', () => {
            sections.splice(index, 1);
            renderSections();
        });
    });
  }

  document.getElementById('btnVideo').addEventListener('click', () => {
    sections.push({ type: 'video', url: '', label: '' });
    renderSections();
  });

  document.getElementById('btnPdf').addEventListener('click', () => {
    sections.push({ type: 'pdf', url: '', label: '' });
    renderSections();
  });

  // --- 4. Form Submission ---
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Processing...";
    (submitBtn as HTMLButtonElement).disabled = true;

    // --- CRITICAL FIX: SCRAPE DOM FOR LATEST VALUES ---
    // Instead of relying on the 'sections' array state (which might be stale),
    // we read exactly what is in the input boxes right now.
    const freshSections = [];
    document.querySelectorAll('.section-row').forEach(row => {
        const type = (row.querySelector('.inp-type') as HTMLInputElement).value;
        const label = (row.querySelector('.inp-label') as HTMLInputElement).value;
        const url = (row.querySelector('.inp-url') as HTMLInputElement).value;

        // Only add if URL is not empty
        if(url && url.trim() !== "") {
            freshSections.push({ type, label, url });
        }
    });
    // --------------------------------------------------

    const courseId = inpId.value;
    const isEdit = !!courseId;
    
    const payload = {
        title: inpTitle.value,
        description: inpDesc.value,
        sections: freshSections // Use the fresh data!
    };

    const url = isEdit 
        ? `http://localhost:8787/courses/${courseId}`
        : `http://localhost:8787/courses`;
    
    const method = isEdit ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            window.location.reload();
        } else {
            const err = await res.json();
            alert("Error: " + JSON.stringify(err));
        }
    } catch(err) {
        console.error(err);
        alert("Server connection failed");
    } finally {
        submitBtn.textContent = originalText;
        (submitBtn as HTMLButtonElement).disabled = false;
    }
  });
</script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.2s ease-out;
  }
</style>