---
import Layout from '../layouts/Layout.astro';

const url = Astro.url.searchParams.get('url');
const title = Astro.url.searchParams.get('title') || 'PDF Viewer';
const BACKEND_URL = import.meta.env.PUBLIC_BACKEND_URL;
const API_BASE = `${BACKEND_URL}/courses`;

if (!url) return Astro.redirect('/');
---

<Layout title={title}>
  <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <div class="h-screen flex flex-col bg-neutral-950 text-white font-sans overflow-hidden fixed inset-0">
    
    <header class="h-12 bg-neutral-900/90 border-b border-neutral-800 flex items-center justify-between px-4 z-50">
      <button onclick="history.back()" class="p-2 -ml-2 text-neutral-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
      </button>
      <h1 class="font-medium truncate text-[11px] uppercase tracking-widest text-neutral-400">{title}</h1>
      <div id="save-status" class="text-[9px] font-mono text-blue-500 opacity-0 transition-opacity">SAVING</div>
    </header>

    <main class="flex-1 overflow-auto touch-auto bg-neutral-950 relative" id="viewer-container">
      <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-neutral-950 z-20">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
      </div>
      
      <div id="canvas-wrapper" class="inline-flex min-w-full min-h-full items-center justify-center p-4">
        <canvas id="the-canvas" class="shadow-2xl bg-white transition-transform duration-150 ease-out"></canvas>
      </div>
    </main>

    <footer id="smart-nav" class="h-24 bg-neutral-900 border-t border-neutral-800 relative flex items-center justify-center cursor-pointer select-none z-50 touch-none mb-safe">
      <div id="left-feedback" class="absolute inset-y-0 left-0 w-1/2 bg-white/5 opacity-0 pointer-events-none transition-opacity"></div>
      <div id="right-feedback" class="absolute inset-y-0 right-0 w-1/2 bg-white/5 opacity-0 pointer-events-none transition-opacity"></div>
      <div class="absolute inset-y-6 left-1/2 w-px bg-neutral-800/50"></div>

      <div class="flex flex-col items-center gap-1 pointer-events-none">
        <div class="flex items-center gap-12">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-neutral-600"><path d="m15 18-6-6 6-6"/></svg>
            <span id="page_num" class="text-2xl font-black tabular-nums tracking-tighter">--</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-neutral-600"><path d="m9 18 6-6-6-6"/></svg>
        </div>
        <span class="text-[10px] text-neutral-500 font-bold">OF <span id="page_count">--</span> PAGES</span>
      </div>
    </footer>

    <div class="fixed bottom-28 right-4 z-50 flex flex-col items-end gap-3">
        <div id="fab-menu" class="hidden flex-col gap-3 mb-2 items-end">
            <div class="bg-neutral-900 border border-neutral-700 p-3 rounded-2xl shadow-2xl flex items-center gap-2">
                <input type="number" id="goto-page" placeholder="Page" class="w-16 bg-transparent text-white text-sm outline-none px-2 border-b border-neutral-700" />
                <button id="goto-btn" class="bg-white text-black px-4 py-1.5 rounded-xl text-[10px] font-black">GO</button>
            </div>
            <button id="zoom_in" class="p-4 bg-neutral-800 rounded-full shadow-lg border border-neutral-700 active:bg-neutral-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
            <button id="zoom_out" class="p-4 bg-neutral-800 rounded-full shadow-lg border border-neutral-700 active:bg-neutral-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
        </div>
        <button id="fab-toggle" class="p-4 bg-blue-600 text-white rounded-full shadow-2xl transition-all active:scale-90 active:rotate-90">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
        </button>
    </div>
  </div>
</Layout>

<script define:vars={{ url, API_BASE }}>
  window.onload = async function() {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = window.innerWidth < 768 ? 1.0 : 1.5,
        canvas = document.getElementById('the-canvas'),
        ctx = canvas.getContext('2d'),
        saveTimeout = null;

    // --- Smart Navigation (Split Screen Click) ---
    const smartNav = document.getElementById('smart-nav');
    const handleNav = (clientX) => {
        const rect = smartNav.getBoundingClientRect();
        if (clientX < rect.left + rect.width / 2) {
            if (pageNum > 1) { pageNum--; queueRenderPage(pageNum); triggerFeedback('left'); }
        } else {
            if (pageNum < pdfDoc.numPages) { pageNum++; queueRenderPage(pageNum); triggerFeedback('right'); }
        }
    };

    const triggerFeedback = (side) => {
        const el = document.getElementById(`${side}-feedback`);
        el.style.opacity = '1';
        setTimeout(() => el.style.opacity = '0', 150);
    };

    smartNav.addEventListener('touchstart', (e) => handleNav(e.touches[0].clientX));
    smartNav.addEventListener('mousedown', (e) => handleNav(e.clientX));

    // --- FAB Toggle ---
    const fabToggle = document.getElementById('fab-toggle');
    const fabMenu = document.getElementById('fab-menu');
    fabToggle.addEventListener('click', () => {
        fabMenu.classList.toggle('hidden');
        fabMenu.classList.toggle('flex');
    });

    // --- PDF Logic ---
    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(function(page) {
        const viewport = page.getViewport({scale: scale});
        const outputScale = window.devicePixelRatio || 1;
        
        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);
        canvas.style.width = Math.floor(viewport.width) + "px";
        canvas.style.height = Math.floor(viewport.height) + "px";

        const renderContext = { 
            canvasContext: ctx, 
            transform: outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null, 
            viewport: viewport 
        };
        
        page.render(renderContext).promise.then(function() {
          pageRendering = false;
          document.getElementById('loading-spinner').classList.add('hidden');
          if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
        });
      });
      document.getElementById('page_num').textContent = num;
      saveProgress(num);
    }

    function queueRenderPage(num) {
      if (pageRendering) { pageNumPending = num; } else { renderPage(num); }
    }

    // Zoom buttons recalculate scale and re-render
    document.getElementById('zoom_in').addEventListener('click', () => { scale *= 1.25; queueRenderPage(pageNum); });
    document.getElementById('zoom_out').addEventListener('click', () => { scale *= 0.8; queueRenderPage(pageNum); });

    document.getElementById('goto-btn').addEventListener('click', () => {
        const val = parseInt(document.getElementById('goto-page').value);
        if (val >= 1 && val <= pdfDoc.numPages) {
            pageNum = val;
            queueRenderPage(pageNum);
            fabMenu.classList.add('hidden');
        }
    });

    async function loadProgress() {
        try {
            const res = await fetch(`${API_BASE}/utils/progress?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            if (data.page_number) pageNum = data.page_number;
        } catch (e) {}
    }

    function saveProgress(currentPage) {
        const status = document.getElementById('save-status');
        status.classList.remove('opacity-0');
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            try {
                await fetch(`${API_BASE}/utils/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, page: currentPage })
                });
                setTimeout(() => status.classList.add('opacity-0'), 1000);
            } catch (e) {}
        }, 2000);
    }

    try {
        await loadProgress(); 
        const proxyUrl = `${API_BASE}/utils/proxy-pdf?url=${encodeURIComponent(url)}`;
        pdfDoc = await pdfjsLib.getDocument(proxyUrl).promise;
        document.getElementById('page_count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
    } catch (error) {
        document.getElementById('loading-spinner').innerHTML = "Load Error";
    }
  }
</script>

<style>
  /* Custom scrollbar to stay clean */
  #viewer-container::-webkit-scrollbar { width: 4px; height: 4px; }
  #viewer-container::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
  
  /* Critical for "Gallery" feel: Allows native pinch and pan */
  #the-canvas {
    touch-action: manipulation;
    user-select: none;
    -webkit-user-drag: none;
    image-rendering: -webkit-optimize-contrast;
  }

  /* Support for notched phones */
  .mb-safe {
    margin-bottom: env(safe-area-inset-bottom);
  }
</style>