---
import logo from '../assets/astro.svg';
---

<div class="todo-wrapper">
  <div class="header">
    <img src={logo.src} alt="Astro Logo" height="32" />
    <span class="badge">TURSO DB</span>
  </div>

  <div class="input-group">
    <input type="text" id="taskInput" placeholder="What needs to be done?" />
    <button id="addBtn">Add</button>
  </div>

  <ul id="taskList">
    </ul>
</div>

<script>
  // Configuration
  const API_URL = 'https://todo-backend.atrikumar31.workers.dev/todos';
  
  // DOM Elements
  const input = document.getElementById('taskInput') as HTMLInputElement;
  const btn = document.getElementById('addBtn');
  const list = document.getElementById('taskList');

  // --- LOGIC ---

  // 1. Load Tasks (GET)
  async function loadTasks() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('Failed to fetch');
      const tasks = await res.json();
      
      list.innerHTML = ''; // Clear current list
      tasks.forEach(task => renderTask(task));
    } catch (err) {
      console.error(err);
    }
  }

  // 2. Add Task (POST)
  async function addTask() {
    const text = input.value.trim();
    if (!text) return;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      
      if (res.ok) {
        const newTask = await res.json();
        renderTask(newTask);
        input.value = ''; // Clear input
      }
    } catch (err) {
      console.error("Error adding task:", err);
    }
  }

  // 3. Delete Task (DELETE)
  async function deleteTask(id, element) {
    try {
      const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
      if (res.ok) {
        element.remove(); // Remove from UI immediately
      }
    } catch (err) {
      console.error("Error deleting:", err);
    }
  }

  // Helper: Create HTML for a task
  function renderTask(task) {
    const li = document.createElement('li');
    li.className = 'task-item';
    
    const span = document.createElement('span');
    span.textContent = task.text;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '&times;'; // Ã— symbol
    deleteBtn.className = 'delete-btn';
    deleteBtn.onclick = () => deleteTask(task.id, li);

    li.appendChild(span);
    li.appendChild(deleteBtn);
    list?.appendChild(li);
  }

  // Event Listeners
  btn?.addEventListener('click', addTask);
  input?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addTask();
  });

  // Start
  loadTasks();
</script>

<style>
  /* Glassmorphism Card Style */
  .todo-wrapper {
    background: rgba(30, 30, 40, 0.6);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    margin-top: 2rem;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .badge {
    background: linear-gradient(90deg, #D83333, #F041FF);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: bold;
    color: white;
    letter-spacing: 1px;
  }

  .input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  input {
    flex: 1;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 0.8rem 1rem;
    color: white;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus {
    border-color: #bc52ee;
  }

  #addBtn {
    background: white;
    color: black;
    border: none;
    border-radius: 6px;
    padding: 0 1.5rem;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s;
  }

  #addBtn:active {
    transform: scale(0.95);
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  /* Styles for dynamic items need :global because they are created by JS */
  ul :global(.task-item) {
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 0.5rem;
    padding: 0.8rem 1rem;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #e0e0e0;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  ul :global(.task-item:hover) {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.1);
  }

  ul :global(.delete-btn) {
    background: transparent;
    border: none;
    color: #666;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    padding: 0 0.5rem;
    transition: color 0.2s;
  }

  ul :global(.delete-btn:hover) {
    color: #ff4444;
  }
</style>